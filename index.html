<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image to CMU Polygon Code</title>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      flex-direction: column;
    }
    #canvas {
      border: 1px solid black;
      margin-bottom: 20px;
    }
    #output-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #output {
      white-space: pre-wrap;
      font-family: monospace;
      width: 100%;
      max-width: 500px;
      height: 200px;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      overflow: auto;
      background-color: #fafafa;
    }
    #copy-button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
    }
    #copy-button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>

  <div>
    <h1>Convert Image to CMU Polygon Code</h1>
    <input type="file" id="file-input" accept="image/*" />
    <canvas id="canvas" width="400" height="400"></canvas>

    <div id="output-container">
      <textarea id="output" readonly></textarea>
      <button id="copy-button">Copy Code</button>
    </div>
  </div>

  <script>
    function onOpenCvReady() {
      console.log("OpenCV.js is ready.");
    }

    document.getElementById('file-input').addEventListener('change', function (e) {
      let file = e.target.files[0];
      let reader = new FileReader();
      reader.onload = function(event) {
        let img = new Image();
        img.onload = function() {
          // Get canvas and context
          let canvas = document.getElementById('canvas');
          let ctx = canvas.getContext('2d');
          
          // Image dimensions
          let imageWidth = img.width;
          let imageHeight = img.height;

          // Calculate scaling factor to fit the canvas (400x400)
          let scaleX = canvas.width / imageWidth;
          let scaleY = canvas.height / imageHeight;
          let scale = Math.min(scaleX, scaleY); // Scale based on the smallest dimension

          // Clear the canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Draw image centered in canvas
          let scaledWidth = imageWidth * scale;
          let scaledHeight = imageHeight * scale;
          let offsetX = (canvas.width - scaledWidth) / 2;
          let offsetY = (canvas.height - scaledHeight) / 2;
          ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);

          // Now process the image using OpenCV
          let mat = cv.imread(canvas);
          let gray = new cv.Mat();
          cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY);

          // Apply Gaussian blur
          let blurred = new cv.Mat();
          cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);

          // Apply Canny edge detection
          let edges = new cv.Mat();
          cv.Canny(blurred, edges, 100, 200);

          // Find contours
          let contours = new cv.MatVector();
          let hierarchy = new cv.Mat();
          cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

          // Now approximate the contours to polygons
          let polygons = [];
          for (let i = 0; i < contours.size(); i++) {
            let contour = contours.get(i);
            let approx = new cv.Mat();
            // Approximate the contour into a polygon with a tolerance
            cv.approxPolyDP(contour, approx, 5, true);

            // Convert to JS array for easier processing
            let polygon = [];
            for (let j = 0; j < approx.rows; j++) {
              let point = approx.data32S.subarray(j * 2, j * 2 + 2);
              polygon.push([point[0], point[1]]);
            }
            polygons.push(polygon);
            approx.delete();
          }

          // Flatten polygons into one large polygon if needed
          let allPoints = [];
          polygons.forEach(polygon => {
            allPoints.push(...polygon);
          });

          // Apply scaling to the contour points for canvas (0, 0 to 400, 400)
          allPoints = allPoints.map(([x, y]) => [
            Math.floor(x * scale), // Floor x coordinates to integer values
            Math.floor(y * scale)  // Floor y coordinates to integer values
          ]);

          // Ensure the polygon is closed by adding the first point at the end
          allPoints.push(allPoints[0]);

          // Order points counter-clockwise
          // This is to ensure correct polygon drawing and filling
          allPoints.sort((a, b) => Math.atan2(b[1] - a[1], b[0] - a[0]));

          // Generate CMU Polygon Code
          let polygonCode = `Polygon(`;
          allPoints.forEach(([x, y], i) => {
            polygonCode += `${x},${y}`;
            if (i < allPoints.length - 1) {
              polygonCode += ','; // Add comma between coordinates
            }
          });
          polygonCode += `, fill='black')\n`; // Add the fill attribute at the end

          // Display the result in the output section
          document.getElementById('output').value = polygonCode;

          // Clean up OpenCV Mat objects to avoid memory leaks
          mat.delete();
          gray.delete();
          blurred.delete();
          edges.delete();
          hierarchy.delete();
          contours.delete();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    if (cv.getBuildInformation) {
      cv.onRuntimeInitialized = onOpenCvReady;
    }

    // Add copy-to-clipboard functionality
    document.getElementById('copy-button').addEventListener('click', function() {
      let output = document.getElementById('output');
      output.select();
      document.execCommand('copy'); // Copy the code to the clipboard
      alert('Code copied to clipboard!');
    });
  </script>
</body>
</html>
